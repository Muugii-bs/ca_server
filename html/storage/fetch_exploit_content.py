from bs4 import BeautifulSoup as bs 
import mysql.connector as db
import re
import os
import sys
import json

db_config = {
		'host':			'127.0.0.1',
		'port':			3306,
		'user':			'root',
		'password':	'root',
		'database':	'cnl',
		'autocommit': True,
}
conn = db.connect(**db_config)
cursor = conn.cursor()

def fetch():
    for i in os.listdir(os.getcwd()):
        if i.endswith('.txt'):
            with open(i, 'r') as fp:
                exploit_id = i.split('.')[0]
                try:
                    data = json.load(fp)['data']
                    if data:
                        soup = bs(data, 'html.parser')
                        keywords = soup.find('meta', {'name':'keywords'})
                        if keywords == None:
                            os.system('mv ' + i +' ./empty/')
                            print i, 'empty'
                            continue
                        else:
                            keywords = re.sub(r'\n+', '', keywords['content'])
                            table = soup.find('table', {'class':'exploit_list'}).text
                            table = re.sub(r'\n+', '\n', table)
                            sql = 'INSERT IGNORE INTO vuln_exploit_fetched (exploit_db_id, keywords, extra1) VALUES (%s, %s, %s)'
                            cursor.execute(sql, (exploit_id, keywords, table.rstrip().lstrip()))
                            os.system('mv ' + i + ' ./imported/')
                            print i, 'imported'
                    else:
                        continue
                except Exception, e:
                    print i, str(e)

if __name__ == '__main__':
    fetch()
